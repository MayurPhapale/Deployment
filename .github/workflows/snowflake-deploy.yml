name: Snowflake Deployment

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - uat

jobs:
  deploy_to_snowflake:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  

      - name: Debug Branch
        run: echo "Running on branch $GITHUB_REF_NAME"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-connector-python sqlfluff jq

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Extract folder names and SQL files
          SQL_FILES=""
          for FILE in $CHANGED_FILES; do
            if [[ $FILE == */*.sql ]]; then
              SQL_FILES+="$FILE"$'\n'
            fi
          done

          echo "Changed SQL files:"
          echo "$SQL_FILES"

          echo "$SQL_FILES" > changed_files.txt
          echo "sql_files=$(echo "$SQL_FILES" | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Determine Database Name
        id: set-db
        run: |
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          TARGET_BRANCH=${{ github.event.pull_request.base.ref }}

          # Define folder-to-database mapping
          declare -A DATABASE_MAP
          DATABASE_MAP["com_dm"]="DA_COM"
          DATABASE_MAP["fin_dm"]="DA_FIN"
          DATABASE_MAP["mfg_dm"]="DA_MFG"
          DATABASE_MAP["mrkt_dm"]="DA_MRKT"
          DATABASE_MAP["prc_dm"]="DA_PRC"
          DATABASE_MAP["scm_dm"]="DA_SCM"
          DATABASE_MAP["udp"]="DA_UDP"

          # Determine environment suffix
          if [[ "$BRANCH_NAME" == uat_release* ]] && [[ "$TARGET_BRANCH" == "uat" ]]; then
            ENV_SUFFIX="_UAT"
          elif [[ "$BRANCH_NAME" == prod_release* ]] && [[ "$TARGET_BRANCH" == "main" ]]; then
            ENV_SUFFIX="_PROD"
          else
            echo "No matching database for this merge. Skipping deployment."
            exit 0
          fi

          # Determine database for each folder
          DATABASES=""
          while IFS= read -r FILE; do
            FOLDER=$(echo "$FILE" | cut -d'/' -f1)
            if [[ -n "${DATABASE_MAP[$FOLDER]}" ]]; then
              DB_NAME="${DATABASE_MAP[$FOLDER]}$ENV_SUFFIX"
              DATABASES+="$DB_NAME"$'\n'
            fi
          done < changed_files.txt

          # Remove duplicates and set environment variable
          DATABASES=$(echo "$DATABASES" | sort -u)
          echo "Selected Databases:"
          echo "$DATABASES"

          echo "$DATABASES" > databases.txt
          echo "SNOWFLAKE_DATABASES=$(echo "$DATABASES" | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Deploy changed SQL files to Snowflake
        if: ${{ env.sql_files != '' }}
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASES: ${{ env.SNOWFLAKE_DATABASES }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          if [ ! -f changed_files.txt ] || [ ! -s changed_files.txt ]; then
            echo "No changed SQL files found. Exiting."
            exit 0
          fi

          cat > deploy.py << 'EOL'
          import os
          import snowflake.connector
          import sys

          account = os.getenv('SNOWFLAKE_ACCOUNT')
          user = os.getenv('SNOWFLAKE_USER')
          role = os.getenv('SNOWFLAKE_ROLE')
          warehouse = os.getenv('SNOWFLAKE_WAREHOUSE')
          schema = os.getenv('SNOWFLAKE_SCHEMA')
          private_key=os.getenv('SNOWFLAKE_PRIVATE_KEY')

          databases = os.getenv('SNOWFLAKE_DATABASES').split()
          if not databases:
              print("No databases selected. Exiting...")
              sys.exit(0)

          conn = snowflake.connector.connect(
              account=account,
              user=user,
              private_key=private_key,
              role=role,
              warehouse=warehouse
          )
          cursor = conn.cursor()

          with open("changed_files.txt", "r") as f:
              sql_files = [line.strip() for line in f.readlines() if line.strip()]

          if not sql_files:
              print("No SQL files to deploy. Exiting...")
              sys.exit(0)

          for db in databases:
              print(f"Switching to database {db}...")
              cursor.execute(f"USE DATABASE {db};")

              for sql_file in sql_files:
                  folder = sql_file.split('/')[0]
                  expected_db_prefix = f"DA_{folder.upper()}"

                  if expected_db_prefix in db:
                      try:
                          with open(sql_file, "r") as f:
                              sql_content = f.read()
                          print(f"Executing {sql_file} in {db}...")
                          cursor.execute(sql_content)
                      except Exception as e:
                          print(f"Error executing {sql_file}: {e}")
                          sys.exit(1)

          conn.close()
          EOL
          
          python deploy.py
